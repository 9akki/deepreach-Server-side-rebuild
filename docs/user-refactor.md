# 用户体系重构备忘

> 文档版本：2025-11-04  
> 范围：在现有 DeepReach 系统中移除「部门（dept）」概念、重建用户/权限/资金体系时的影响和建议。

## 1. 当前部门依赖概况

- **数据模型层面**
  - `sys_dept` 主表及所有 `dept_id` 外键列（`sys_user.dept_id`、`sys_role_dept.dept_id`、佣金记录中的 `agent_dept_id` / `buyer_dept_id` 等）。
  - 大量初始化/迁移脚本：`sql/authority.sql`、`sql/role_rebuild.sql`、`sql/accountDesign.sql`、`sql/create_test_data.sql` 等都默认以部门层级构造组织树。
- **Java 代码引用**  
  - 至少 22 个类显式引用 `deptId`，21 个类引用 `deptType`；覆盖实体、DTO、控制器、服务、Mapper、权限工具等模块。
  - 核心依赖面：`SysDeptServiceImpl`、`SysUserServiceImpl`、`AgentCommissionServiceImpl`、`UserDrBalanceServiceImpl`、`BuyerInstanceStatisticsServiceImpl`、`DeptUtils`、`DataScopeCalculator`。
- **业务逻辑依赖**
  - 权限模型：登录态 `LoginUser`、`JwtTokenUtil` 将 `deptId/deptType` 写入 Token；数据范围控制通过部门祖先链计算。
  - 资金链路：代理佣金结算、买家余额调账均通过部门层级识别角色。
  - 报表统计：买家实例报表、后台统计接口按部门聚合。

## 2. 重构步骤建议

| 阶段 | 目标 | 关键动作 |
| ---- | ---- | ---- |
| 1. 定义替代模型 | 明确新的组织/角色抽象，确定是否引入“代理树”“买家分组”等实体 | 制定实体关系图，梳理权限规则、资金归属规则 |
| 2. 双轨改造 | 在不破坏线上功能的前提下，引入新模型并写兼容代码 | 逐步为核心服务增加“新模型”判定分支，保留旧字段；编写迁移脚本填充新结构 |
| 3. 切换与清理 | 全量替换接口、移除旧部门依赖 | 回归核心流程，移除 `dept` 字段与相关校验，清理脚本及文档 |

> **关键原则**：先让新模型在旁路运行并获得数据，再逐步把主流程切过去，最后删除老逻辑。

## 3. 影响面拆解

- **接口与前端**
  - `/system/dept`, `/system/user`、代理结算、余额调账等接口的请求/响应结构均含 `deptId`；需要设计新字段或新接口替换。
  - 前端页面、表格展示、“部门树”控件需同步替换为新的组织呈现方式。
- **权限系统**
  - 所有基于部门层级的权限判定必须迁移至新的关联关系（例如基于代理-客户树、角色标签等）。
  - `sys_role_dept`、`DeptUtils`、`DataScopeCalculator` 等工具类需要重写或废弃。
- **资金与结算**
  - 佣金分发、买家余额维护需要从“代理部门层级”转变为“代理用户层级”或其它替代信息。
  - 数据库中的 `agent_dept_id`/`buyer_dept_id` 字段要么转换为新外键，要么废弃。
- **初始化脚本与测试数据**
  - 初始化账号、部门拓扑、批量脚本（含重置密码、导入测试数据等）均需重新设计。

## 4. 数据迁移思路

1. **抽取现有关系**：通过 `sys_user.dept_id` + `sys_dept.dept_type/level` 生成新的组织树或标签映射，落入过渡表。
2. **补充缺省信息**：对未填写负责人、层级的历史数据，提前生成旁路标记（避免上线后出现孤儿数据）。
3. **全量回填与校验**：在新表/字段写入完成后执行对账脚本，确保用户数量、资金余额、佣金等指标一致。
4. **灰度切换**：上线新接口后，按批量迁移用户，观察日志与监控；确认稳定再删除旧字段。

## 5. 风险与验证

- **权限穿透风险**：拆掉部门后，代理/买家层级权限点需要重新验证，建议补充自动化测试覆盖典型场景。
- **财务数据一致性**：任何资金相关表结构调整务必先在影子库演练，确保余额、流水、佣金不丢失。
- **历史报表**：如果保留老数据，需要定义新旧模型下的报表兼容策略，避免统计口径变化导致误差。

## 6. 推荐配套工作

- 制定分支策略与迁移计划，事先开跨团队评审会明确范围、时间线、回滚预案。
- 为新模型准备详细的 ER 图、接口契约、API 文档。
- 建立自动化验证脚本（数据校验、回归用例）和运行手册。

---

如需继续拆分任务，可在此文档后补充「里程碑与负责人」「测试计划」等附录。该文档将随重构进度实时更新。 
