<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.deepreach.web.mapper.UserDrBalanceMapper">

    <!-- 通用结果映射 -->
    <resultMap id="BaseResultMap" type="com.deepreach.web.entity.UserDrBalance">
        <id column="balance_id" property="balanceId" />
        <result column="user_id" property="userId" />
        <result column="dr_balance" property="drBalance" />
        <result column="pre_deducted_balance" property="preDeductedBalance" />
        <result column="total_recharge" property="totalRecharge" />
        <result column="total_consume" property="totalConsume" />
        <result column="total_refund" property="totalRefund" />
        <result column="frozen_amount" property="frozenAmount" />
        <result column="version" property="version" />
        <result column="status" property="status" />
        <result column="ai_character_free_times" property="aiCharacterFreeTimes" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="remark" property="remark" />
    </resultMap>

    <!-- 通用列名 -->
    <sql id="Base_Column_List">
        balance_id, user_id, dr_balance, pre_deducted_balance, total_recharge, total_consume,
        total_refund, frozen_amount, version, status, ai_character_free_times, create_by, create_time, update_by, update_time, remark
    </sql>

    <!-- 根据用户ID查询余额信息 -->
    <select id="selectByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select <include refid="Base_Column_List" />
        from user_dr_balance
        where user_id = #{userId}
    </select>

    <!-- 分页查询余额列表 -->
    <select id="selectBalancePage" parameterType="com.deepreach.web.entity.UserDrBalance" resultMap="BaseResultMap">
        select <include refid="Base_Column_List" />
        from user_dr_balance
        <where>
            <if test="userId != null">
                and user_id = #{userId}
            </if>
            <if test="status != null and status != ''">
                and status = #{status}
            </if>
            <if test="drBalance != null">
                and dr_balance = #{drBalance}
            </if>
            <if test="params.beginTime != null and params.beginTime != ''">
                and date_format(create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                and date_format(create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
            </if>
        </where>
        order by create_time desc
    </select>

    <!-- 插入余额记录 -->
    <insert id="insert" parameterType="com.deepreach.web.entity.UserDrBalance" useGeneratedKeys="true" keyProperty="balanceId">
        insert into user_dr_balance (
            user_id, dr_balance, pre_deducted_balance, total_recharge, total_consume,
            total_refund, frozen_amount, version, status, ai_character_free_times, create_by, create_time, remark
        ) values (
            #{userId}, #{drBalance}, #{preDeductedBalance}, #{totalRecharge}, #{totalConsume},
            #{totalRefund}, #{frozenAmount}, #{version}, #{status}, #{aiCharacterFreeTimes}, #{createBy}, #{createTime}, #{remark}
        )
    </insert>

    <!-- 更新余额信息 -->
    <update id="update" parameterType="com.deepreach.web.entity.UserDrBalance">
        update user_dr_balance
        <set>
            <if test="drBalance != null">
                dr_balance = #{drBalance},
            </if>
            <if test="preDeductedBalance != null">
                pre_deducted_balance = #{preDeductedBalance},
            </if>
            <if test="totalRecharge != null">
                total_recharge = #{totalRecharge},
            </if>
            <if test="totalConsume != null">
                total_consume = #{totalConsume},
            </if>
            <if test="totalRefund != null">
                total_refund = #{totalRefund},
            </if>
            <if test="frozenAmount != null">
                frozen_amount = #{frozenAmount},
            </if>
            <if test="version != null">
                version = #{version} + 1,
            </if>
            <if test="status != null and status != ''">
                status = #{status},
            </if>
            <if test="aiCharacterFreeTimes != null">
                ai_character_free_times = #{aiCharacterFreeTimes},
            </if>
            <if test="updateBy != null and updateBy != ''">
                update_by = #{updateBy},
            </if>
            update_time = #{updateTime}
        </set>
        where balance_id = #{balanceId}
    </update>

    <!-- 乐观锁更新余额 -->
    <update id="updateBalanceWithVersion">
        update user_dr_balance
        set dr_balance = #{drBalance},
            pre_deducted_balance = #{preDeductedBalance},
            total_recharge = #{totalRecharge},
            total_consume = #{totalConsume},
            total_refund = #{totalRefund},
            frozen_amount = #{frozenAmount},
            version = version + 1,
            update_time = now()
        where user_id = #{userId}
          and version = #{version}
    </update>

    <!-- 更新用户余额状态 -->
    <update id="updateStatus">
        update user_dr_balance
        set status = #{status},
            update_by = #{updateBy},
            update_time = now()
        where user_id = #{userId}
    </update>

    <!-- 根据状态查询余额列表 -->
    <select id="selectByStatus" parameterType="java.lang.String" resultMap="BaseResultMap">
        select <include refid="Base_Column_List" />
        from user_dr_balance
        where status = #{status}
        order by create_time desc
    </select>

    <!-- 统计余额总数 -->
    <select id="countTotal" resultType="java.lang.Long">
        select count(*) from user_dr_balance
    </select>

    <!-- 统计正常状态的余额总数 -->
    <select id="countNormal" resultType="java.lang.Long">
        select count(*) from user_dr_balance where status = '0'
    </select>

    <!-- 统计冻结状态的余额总数 -->
    <select id="countFrozen" resultType="java.lang.Long">
        select count(*) from user_dr_balance where status = '1'
    </select>

    <!-- 查询余额为0的用户数量 -->
    <select id="countZeroBalance" resultType="java.lang.Long">
        select count(*) from user_dr_balance where dr_balance = 0.00
    </select>

    <!-- 查询余额大于指定金额的用户数量 -->
    <select id="countBalanceGreaterThan" parameterType="java.math.BigDecimal" resultType="java.lang.Long">
        select count(*) from user_dr_balance where dr_balance > #{amount}
    </select>

    <!-- 获取余额统计信息 -->
    <select id="selectBalanceStatistics" parameterType="java.lang.Long" resultType="java.util.Map">
        select
            dr_balance as currentBalance,
            pre_deducted_balance as preDeductedBalance,
            total_recharge as totalRecharge,
            total_consume as totalConsume,
            total_refund as totalRefund,
            frozen_amount as frozenAmount,
            status as status,
            (dr_balance - frozen_amount) as availableBalance,
            (dr_balance + pre_deducted_balance - frozen_amount) as totalAvailableBalance
        from user_dr_balance
        where user_id = #{userId}
    </select>

    <!-- 批量更新余额状态 -->
    <update id="batchUpdateStatus">
        update user_dr_balance
        set status = #{status},
            update_by = #{updateBy},
            update_time = now()
        where user_id in
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </update>
    <update id="deductForToken">
        update user_dr_balance
        set dr_balance = #{drBalance},
            total_consume = #{totalConsume},
            version = version + 1,
            update_time = now()
        where user_id = #{userId}
    </update>

    <update id="consumeAiCharacterFreeTimes">
        update user_dr_balance
        set ai_character_free_times = ai_character_free_times - 1,
            update_time = now()
        where user_id = #{userId}
          and ai_character_free_times &gt; 0
    </update>

    <!-- 删除余额记录 -->
    <delete id="deleteByUserId" parameterType="java.lang.Long">
        delete from user_dr_balance where user_id = #{userId}
    </delete>

</mapper>
